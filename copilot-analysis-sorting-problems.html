<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Analysis: Sorting Features in saros Package • saros</title><script src="lightswitch.js"></script><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Analysis: Sorting Features in saros Package"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">saros</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.6.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/for_chapter_author.html">UNKNOWN TITLE</a></li>
    <li><a class="dropdown-item" href="articles/for_developers.html">UNKNOWN TITLE</a></li>
    <li><a class="dropdown-item" href="articles/for_readers.html">UNKNOWN TITLE</a></li>
    <li><a class="dropdown-item" href="articles/saros_name.html">UNKNOWN TITLE</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NIFU-NO/saros/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Analysis: Sorting Features in saros Package</h1>
      <small class="dont-index">Source: <a href="https://github.com/NIFU-NO/saros/blob/main/copilot-analysis-sorting-problems.md" class="external-link"><code>copilot-analysis-sorting-problems.md</code></a></small>
    </div>

<div id="analysis-sorting-features-in-saros-package" class="section level1">

<p><strong>Date</strong>: October 17, 2025<br><strong>Branch</strong>: fix/improve-sorting-functionality<br><strong>File</strong>: R/sorting_utils.R</p>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a></h2>
<p>This document analyzes the current implementation of <code>sort_dep_by</code> and <code>sort_indep_by</code> features in the makeme function, identifying improvement areas to ensure all kinds of sorting are possible and correct.</p>
</div>
<div class="section level2">
<h2 id="status-update-oct-19-2025">Status Update (Oct 19, 2025)<a class="anchor" aria-label="anchor" href="#status-update-oct-19-2025"></a></h2>
<p>Completed and verified (tests and R CMD check passing): - Replaced custom positional logic with <code><a href="reference/subset_vector.html">subset_vector()</a></code> via <code><a href="reference/get_target_categories.html">get_target_categories()</a></code> - Standardized aggregation rules: - <code>.count</code> (dep and indep) uses sum across groups - <code>.count_total_indep</code> uses sum - <code>.sum_value</code> uses sum - Other numeric/statistical columns retain prior semantics (e.g., mean/median where applicable) - Removed redundant numeric conversions (<code>.proportion</code>, <code>.count</code> already numeric) - Standardized descending logic for independent-variable sorting via <code><a href="reference/arrange_with_order.html">arrange_with_order()</a></code></p>
<p>Pending/partial: - Dependent-variable descending logic still uses <code>descend_if_descending()</code>; needs migration to <code><a href="reference/arrange_with_order.html">arrange_with_order()</a></code> for full consistency - Default behavior for <code>sort_indep_by = NULL</code> remains implicit; consider explicit <code>.original</code> option - Validation, documentation, and edge-case tests to be improved</p>
<hr></div>
<div class="section level2">
<h2 id="key-improvement-areas-remaining">Key Improvement Areas (Remaining)<a class="anchor" aria-label="anchor" href="#key-improvement-areas-remaining"></a></h2>
<div class="section level3">
<h3 id="id_1-missing-sorting-options-medium-priority">1. Missing Sorting Options [MEDIUM PRIORITY]<a class="anchor" aria-label="anchor" href="#id_1-missing-sorting-options-medium-priority"></a></h3>
<p><strong>Currently Supported</strong>: - ✅ Positional: <code>.top</code>, <code>.bottom</code>, <code>.upper</code>, <code>.lower</code>, <code>.mid_upper</code>, <code>.mid_lower</code> - ✅ Column-based: <code>.count</code>, <code>.proportion</code>, <code>.mean</code>, <code>.median</code>, <code>.sum_value</code> - ✅ Category-based: Single category (e.g., “Not at all”) or multiple categories - ✅ Alphabetical: <code>.variable_label</code>, <code>.variable_name</code> - ✅ Original order: <code>.variable_position</code></p>
<p><strong>Potentially Missing</strong>: - ❓ <code>.count_per_indep_group</code> - partially implemented but may need testing - ❓ Custom sorting by other columns in the data - ❓ Sorting by statistical measures (variance, std dev, range, etc.) - ❓ Sorting by difference between groups (e.g., gender gap)</p>
<p><strong>Proposed Solution</strong>: - Audit current test coverage to identify which options are fully tested - Document which options are supported and provide examples - Consider adding statistical measures if there’s user demand</p>
<p><strong>Impact</strong>: Improves feature completeness, clarifies capabilities</p>
<hr></div>
<div class="section level3">
<h3 id="id_2-default-sorting-behavior-not-clear-resolved">2. Default Sorting Behavior Not Clear [RESOLVED]<a class="anchor" aria-label="anchor" href="#id_2-default-sorting-behavior-not-clear-resolved"></a></h3>
<p><strong>Change</strong>: - <code>sort_indep_by</code> now explicitly defaults to <code>".factor_order"</code> in the public API. - Passing <code>NULL</code> is accepted and treated as <code>".factor_order"</code>. - If <code>indep = NULL</code>, specifying <code>sort_indep_by</code> or <code>descend_indep</code> is ignored (no errors).</p>
<p><strong>Impact</strong>: Clear and predictable behavior; avoids errors when indep is not provided.</p>
<hr></div>
<div class="section level3">
<h3 id="id_3-descending-logic-consistency-resolved">3. Descending Logic Consistency [RESOLVED]<a class="anchor" aria-label="anchor" href="#id_3-descending-logic-consistency-resolved"></a></h3>
<p>Status (Oct 20, 2025): - Dependent-variable ordering is now fully unified via <code><a href="reference/arrange_with_order.html">arrange_with_order()</a></code> across helpers: - <code><a href="reference/calculate_proportion_order.html">calculate_proportion_order()</a></code>, <code><a href="reference/calculate_multiple_category_order.html">calculate_multiple_category_order()</a></code>, <code><a href="reference/calculate_category_order.html">calculate_category_order()</a></code>, <code><a href="reference/calculate_column_order.html">calculate_column_order()</a></code>, and <code><a href="reference/calculate_sum_value_order.html">calculate_sum_value_order()</a></code> thread <code>descend</code> and sort within the helper. - No post-hoc <code>descend_if_descending()</code> is applied for dependent ordering anymore. - Independent-variable ordering remains unified; <code><a href="reference/arrange_with_order.html">arrange_with_order()</a></code> is used across indep helpers, while <code>descend_if_descending()</code> is intentionally retained only for the special <code>.factor_order</code>/ordered-factor precedence path.</p>
<p>Impact: Single, uniform approach for descending dependent-variable sorting reduces drift. The indep special-case preserves intended semantics for ordered factors.</p>
<p>Notes: - Category-related helpers in <code><a href="reference/summarize_cat_cat_data.html">summarize_cat_cat_data()</a></code> now use <code>sort_dep_by</code> (not <code>sort_indep_by</code>), and when all deps are ordered, category collapsing/exception flipping is disabled by passing <code>sort_by = NULL</code> to those helpers. - Public API: <code>sort_indep_by</code> defaults to <code>.factor_order</code>; <code>NULL</code> is accepted and treated as <code>.factor_order</code>. If <code>indep = NULL</code>, specifying <code>sort_indep_by</code>/<code>descend_indep</code> is ignored.</p>
<hr></div>
<div class="section level3">
<h3 id="id_4-error-handling-and-validation-medium-priority">4. Error Handling and Validation [MEDIUM PRIORITY]<a class="anchor" aria-label="anchor" href="#id_4-error-handling-and-validation-medium-priority"></a></h3>
<p><strong>Missing Validation</strong>: - No check that requested sorting columns exist - No check that requested categories exist in the data - No clear error messages when sorting fails - No validation of data types</p>
<p><strong>Proposed Validation</strong>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">validate_sort_column</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">column_name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">column_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_abort</a></span><span class="op">(</span><span class="st">"Column {.field {column_name}} not found in data"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">validate_sort_category</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">category_value</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">category_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">.category</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">available</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">.category</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span></span>
<span>    <span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_abort</a></span><span class="op">(</span></span>
<span>      <span class="st">"Category {.val {category_value}} not found. Available: {available}"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Impact</strong>: Better user experience, easier debugging</p>
<hr></div>
<div class="section level3">
<h3 id="id_5-testing-coverage-for-edge-cases-medium-priority">5. Testing Coverage for Edge Cases [MEDIUM PRIORITY]<a class="anchor" aria-label="anchor" href="#id_5-testing-coverage-for-edge-cases-medium-priority"></a></h3>
<p><strong>Need to Ensure Tests Cover</strong>: - ✅ Single dependent variable (no sorting needed) - ✅ Multiple dependent variables with various sorting options - ✅ Independent variables with various sorting options - ❓ Data with missing values (NA handling in sorting) - ❓ Data with ties (multiple variables/categories with same values) - ❓ Ordered vs unordered factors - ❓ Combinations of sorting (e.g., <code>sort_dep_by = ".top"</code> + <code>sort_indep_by = "Not at all"</code>) - ❓ Edge cases like single category, all NAs, etc.</p>
<p><strong>Proposed Action</strong>: - Audit current test suite for coverage - Add tests for identified gaps - Document expected behavior for edge cases</p>
<p><strong>Impact</strong>: Increases reliability, catches regression bugs</p>
<hr></div>
<div class="section level3">
<h3 id="id_6-documentation-improvements-low-priority">6. Documentation Improvements [LOW PRIORITY]<a class="anchor" aria-label="anchor" href="#id_6-documentation-improvements-low-priority"></a></h3>
<p><strong>Needed Documentation</strong>: - Clear explanation of what each sorting option does - Examples showing all supported sorting combinations - Explanation of when to use each sorting method - Behavior with missing values - Interaction between sort_dep_by and sort_indep_by</p>
<p><strong>Proposed Action</strong>: - Add comprehensive examples to function documentation - Create vignette explaining sorting options - Add decision tree for choosing sorting method</p>
<p><strong>Impact</strong>: Improves usability, reduces support burden</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="specific-refactoring-recommendations">Specific Refactoring Recommendations<a class="anchor" aria-label="anchor" href="#specific-refactoring-recommendations"></a></h2>
<div class="section level3">
<h3 id="updated-steps-focused-on-remaining-work">Updated Steps (focused on remaining work)<a class="anchor" aria-label="anchor" href="#updated-steps-focused-on-remaining-work"></a></h3>
<ol style="list-style-type: decimal"><li>Migrate dependent-variable helpers to <code><a href="reference/arrange_with_order.html">arrange_with_order()</a></code>
</li>
</ol><ul><li>Add <code>descend</code> parameter to: <code>calculate_proportion_order</code>, <code>calculate_category_order</code>, <code>calculate_multiple_category_order</code>, <code>calculate_column_order</code> (already accepts), and <code>calculate_sum_value_order</code> (already accepts)</li>
<li>Use <code><a href="reference/arrange_with_order.html">arrange_with_order()</a></code> internally instead of fixed ascending</li>
<li>Remove <code>descend_if_descending()</code> from <code><a href="reference/add_dep_order.html">add_dep_order()</a></code> once all callers migrated</li>
</ul><ol start="2" style="list-style-type: decimal"><li>Clarify default indep sorting behavior</li>
</ol><ul><li>Add explicit <code>.original</code> (or <code>.factor_order</code>) option to preserve factor-level order</li>
<li>Document that <code>NULL</code> means “no sorting” (keep incoming order)</li>
</ul><ol start="3" style="list-style-type: decimal"><li>Validation utilities</li>
</ol><ul><li>
<code>validate_sort_column(data, column)</code> and <code>validate_sort_category(data, value)</code> as proposed earlier</li>
<li>Fail fast with clear cli errors</li>
</ul><ol start="4" style="list-style-type: decimal"><li>Tests and docs</li>
</ol><ul><li>Add regression tests covering ties, NAs, ordered vs unordered factors, and combined dep+indep sorting</li>
<li>Expand docs and vignette to document all sorting modes and their interactions</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="priority-order-for-implementation">Priority Order for Implementation<a class="anchor" aria-label="anchor" href="#priority-order-for-implementation"></a></h2>
<div class="section level3">
<h3 id="updated-priority-order">Updated Priority Order<a class="anchor" aria-label="anchor" href="#updated-priority-order"></a></h3>
<p>Phase 1: 1. Standardize descending logic for dependent variables via <code><a href="reference/arrange_with_order.html">arrange_with_order()</a></code>; remove <code>descend_if_descending()</code></p>
<p>Phase 2: 2. Clarify/document default indep sorting (<code>NULL</code> vs <code>.original</code>) 3. Add validation helpers and integrate</p>
<p>Phase 3: 4. Edge-case tests for ties/NA/ordered factors and combined sorting 5. Documentation/vignette updates</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="implementation-strategy">Implementation Strategy<a class="anchor" aria-label="anchor" href="#implementation-strategy"></a></h2>
<div class="section level3">
<h3 id="iterative-approach">Iterative Approach<a class="anchor" aria-label="anchor" href="#iterative-approach"></a></h3>
<ul><li>Make ONE small change at a time</li>
<li>Test after each change</li>
<li>Commit when tests pass</li>
<li>Document what changed and why</li>
</ul></div>
<div class="section level3">
<h3 id="testing-protocol">Testing Protocol<a class="anchor" aria-label="anchor" href="#testing-protocol"></a></h3>
<p>After each change: 1. Run <code>devtools::test()</code> to ensure all tests pass 2. Run <code>devtools::check()</code> to catch any new issues 3. Manually test a few common use cases 4. Review code for any unintended side effects</p>
</div>
<div class="section level3">
<h3 id="risk-mitigation">Risk Mitigation<a class="anchor" aria-label="anchor" href="#risk-mitigation"></a></h3>
<ul><li>Keep changes small and focused</li>
<li>Maintain backward compatibility</li>
<li>Add tests before refactoring if coverage is insufficient</li>
<li>Document any behavior changes</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a></h2>
<ol style="list-style-type: decimal"><li>Migrate dep helpers to <code>arrange_with_order(descend)</code> and drop <code>descend_if_descending()</code>
</li>
<li>Add <code>.original</code> indep option; document <code>NULL</code> semantics</li>
<li>Introduce validation helpers and wire them into sorting entry points</li>
<li>Add edge-case tests and update docs/vignette</li>
</ol><hr></div>
<div class="section level2">
<h2 id="notes">Notes<a class="anchor" aria-label="anchor" href="#notes"></a></h2>
<ul><li>This analysis is based on the current state of R/sorting_utils.R</li>
<li>Some issues may be partially addressed in other parts of the codebase</li>
<li>User feedback and actual usage patterns should guide priority of feature additions</li>
<li>Maintain focus on reliability and consistency over adding new features</li>
</ul></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Stephan Daus, Nordic Institute for The Studies of Innovation, Research and Education (NIFU), Kristiania University College.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

